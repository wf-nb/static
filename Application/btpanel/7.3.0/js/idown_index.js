var idown_version="1.0";$(".layui-layer-page").css({"width":"900px"});$(".bt-w-menu p").click(function(){console.log("点击了菜单");var i=$(this).index();$(this).addClass("bgw").siblings().removeClass("bgw");$(".plugin_body > div").hide().eq(i).show();switch(i){case 0:idown.get_down_index();break;case 1:idown.get_down_new();break;case 2:idown.get_down_active();break;case 3:idown.get_down_stop();break}});var idown={get_down_index:function(){request_plugin("idown","get_panel_indexinfo",{},function(rdata){if(rdata["idown_status"]=="run"){$("#idown_status").prop("checked",true)}else{$("#idown_status").prop("checked",false)}$("#idown_rpc_token").val(rdata["idown_rpc_token"]);$("#webapi_token").val(rdata["idown_webapi_token"]);$("#api_url").val("http://"+rdata["idown_serverip"]+":8001/api");$("#api_help").attr("src","http://"+rdata["idown_serverip"]+":8001/help")})},get_down_new:function(){$("#download_new_link").val("");var obj=document.getElementById("download_new_bt_link");obj.outerHTML=obj.outerHTML;$("#download_textarea_placeholder").show();console.log("显示了下载地址的遮罩层")},get_down_active:function(){request_plugin("idown","download_list_active",{},function(rdata){var num_active=count_array(rdata["Active"]["result"]);var num_wait=count_array(rdata["Wait"]["result"]);var HtmlTable="";if(num_active==0&&num_wait==0){var HtmlTable='<tr><td colspan="2">没有找到相关任务！</td></tr>'}else{for(var i=0;i<num_active;i++){var filename;try{filename=rdata["Active"]["result"][i]["bittorrent"]["info"]["name"];if(filename.length>35){filename=filename.substr(0,35);filename=filename+"..."}}catch(err){filename="[METADATA]"+rdata["Active"]["result"][i]["infoHash"]}var size=rdata["Active"]["result"][i]["totalLength"];size=getsize(size,3);var speed=rdata["Active"]["result"][i]["downloadSpeed"];speed=getsize(speed,1);var percent=(rdata["Active"]["result"][i]["completedLength"]/rdata["Active"]["result"][i]["totalLength"]*100).toFixed(3);HtmlTable=HtmlTable+"<tr><td>"+filename+'</td><td><button gid="'+rdata["Active"]["result"][i]["gid"]+'" onclick="idown.button_start(this)">开始</button><button gid="'+rdata["Active"]["result"][i]["gid"]+'" onclick="idown.button_pause(this)">暂停</button><button gid="'+rdata["Active"]["result"][i]["gid"]+'" onclick="idown.button_del_downing(this)">删除</button></td></tr>';HtmlTable=HtmlTable+'<tr><td colspan="2">Size:'+size+"&nbsp;&nbsp;&nbsp;Speed:"+speed+"&nbsp;&nbsp;&nbsp;Percent:"+percent+"%&nbsp;&nbsp;&nbsp;State:"+'<span style="color:green">正在下载</span>'+"</td></tr>"}for(var i=0;i<num_wait;i++){var filename;try{filename=rdata["Wait"]["result"][i]["bittorrent"]["info"]["name"];if(filename.length>35){filename=filename.substr(0,35);filename=filename+"..."}}catch(err){filename="[METADATA]"+rdata["Wait"]["result"][i]["infoHash"]}var size=rdata["Wait"]["result"][i]["totalLength"];size=getsize(size,3);var speed=rdata["Wait"]["result"][i]["downloadSpeed"];speed=getsize(speed,1);var percent=(rdata["Wait"]["result"][i]["completedLength"]/rdata["Wait"]["result"][i]["totalLength"]*100).toFixed(3);HtmlTable=HtmlTable+"<tr><td>"+filename+'</td><td><button gid="'+rdata["Wait"]["result"][i]["gid"]+'" onclick="idown.button_start(this)">开始</button><button gid="'+rdata["Wait"]["result"][i]["gid"]+'" onclick="idown.button_pause(this)">暂停</button><button gid="'+rdata["Wait"]["result"][i]["gid"]+'" onclick="idown.button_del_downing(this)">删除</button></td></tr>';HtmlTable=HtmlTable+'<tr><td colspan="2">Size:'+size+"&nbsp;&nbsp;&nbsp;Speed:"+speed+"&nbsp;&nbsp;&nbsp;Percent:"+percent+"%&nbsp;&nbsp;&nbsp;State:"+'<span style="color:orange">下载暂停</span>'+"</td></tr>"}}$("#table_list_active").html(HtmlTable)})},get_down_stop:function(){request_plugin("idown","download_list_stop",{},function(rdata){var num=count_array(rdata["result"]);var HtmlTable="";if(num==0){var HtmlTable='<tr><td colspan="2">没有找到相关任务！</td></tr>'}else{for(var i=0;i<num;i++){var filename;if(count_array(rdata["result"][i]["files"])==1){var temp=rdata["result"][i]["files"][0]["path"].split("/");var length=count_array(temp);filename=temp[length-1]}else{var temp=rdata["result"][i]["files"][0]["path"].split("/");var length=count_array(temp);filename=temp[length-2]}if(filename.length>35){filename=filename.substr(0,35);filename=filename+"..."}var size=rdata["result"][i]["totalLength"];size=getsize(size,3);var speed=rdata["result"][i]["downloadSpeed"];speed=getsize(speed,1);var percent=(rdata["result"][i]["completedLength"]/rdata["result"][i]["totalLength"]*100).toFixed(3);HtmlTable=HtmlTable+"<tr><td>"+filename+'</td><td><button gid="'+rdata["result"][i]["gid"]+'" onclick="idown.button_del_over(this,0)">删除(保留文件)</button><button gid="'+rdata["result"][i]["gid"]+'" onclick="idown.button_del_over(this,1)">彻底删除(删除文件)</button></td></tr>';HtmlTable=HtmlTable+'<tr><td colspan="2">Size:'+size+"&nbsp;&nbsp;&nbsp;Speed:"+speed+"&nbsp;&nbsp;&nbsp;Percent:"+percent+"%&nbsp;&nbsp;&nbsp;State:"+'<span style="color:green">下载完成</span>'+"</td></tr>"}}$("#table_list_stop").html(HtmlTable)})},button_newdownload:function(){var loadT=layer.msg("正在添加新的下载任务...",{icon:16,time:0,shade:[0.3,"#000"]});
var txt=$("#download_new_link").val();if(txt!=""){var regex=true;_link=txt;if(_link!=""&&regex){var regex_http=/^http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?$/;var regex_ftp=/^ftp:\/\/(([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)((d|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5]))$)|^ftp:\/\/([a-zA-Z0-9_-])+:([a-zA-Z0-9_-])+@(([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.)((d|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5])))\.){2}([1-9]|([1-9]\d)|(1\d\d)|(2([0-4]\d|5[0-5]))$)/;var regex_magnet=/^(magnet:\?xt=urn:btih:)[0-9a-zA-Z]{32,}.*$/;if(!regex_http.test(_link)&&!regex_ftp.test(_link)&&!regex_magnet.test(_link)){layer.close(loadT);layer.msg("您输入的下载地址有误，请输入正确的下载地址，支持http/https/ftp/magnet格式的链接",{icon:5});idown.get_down_new();regex=false}}if(regex==true){data="link="+_link;request_plugin("idown","download_addnew_link",data,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("新建下载 任务成功",{icon:1})}else{layer.close(loadT);layer.msg("新建下载任务失败"+rdata["mes"],{icon:5})}idown.get_down_new()})}}else{var bt_link=$("#download_new_bt_link").val();if(bt_link==""){layer.close(loadT);layer.msg("请输入需要下载的文件链接地址或者上传种子文件",{icon:5});idown.get_down_new()}else{var name=$("#download_new_bt_link")[0].files[0].name;var _name=name.split(".");var i=_name.length;if(_name[i-1]!="torrent"&&_name[i-1]!="TORRENT"){layer.close(loadT);layer.msg("仅支持torrent格式的种子文件",{icon:5});idown.get_down_new()}else{var formData=new FormData();formData.append("file",$("#download_new_bt_link")[0].files[0]);request_plugin("idown","download_addnew_bt",formData,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("新建BT下载 任务成功",{icon:1})}else{layer.close(loadT);layer.msg("新建BT下载任务失败"+rdata["mes"],{icon:5})}idown.get_down_new()},true)}}}},aria2c_server:function(){if($("#idown_status").prop("checked")){var loadT=layer.msg("正在关闭远程下载服务...",{icon:16,time:0,shade:[0.3,"#000"]});request_plugin("idown","server_stop",{},function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("关闭远程下载服务成功",{icon:1})}else{layer.close(loadT);layer.msg("关闭远程下载服务失败"+rdata["mes"],{icon:5})}})}else{var loadT=layer.msg("正在启动远程下载服务...",{icon:16,time:0,shade:[0.3,"#000"]});request_plugin("idown","server_start",{},function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("启动远程下载服务成功",{icon:1})}else{layer.close(loadT);layer.msg("启动远程下载服务失败"+rdata["mes"],{icon:5})}})}},hide_placeholder:function(){$("#download_textarea_placeholder").hide();console.log("隐藏下载地址的遮罩层")},button_start:function(button){var loadT=layer.msg("正在启动任务...",{icon:16,time:0,shade:[0.3,"#000"]});var gid=button.getAttribute("gid");var post="gid="+gid;request_plugin("idown","download_start_alone",post,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("启动任务成功...",{icon:1});idown.get_down_active()}else{layer.close(loadT);layer.msg("启动任务失败..."+rdata["mes"],{icon:5})}})},button_pause:function(button){var loadT=layer.msg("正在删除任务...",{icon:16,time:0,shade:[0.3,"#000"]});var gid=button.getAttribute("gid");var post="gid="+gid;request_plugin("idown","download_pause_alone",post,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("删除任务成功...",{icon:1});idown.get_down_active()}else{layer.close(loadT);layer.msg("删除任务失败..."+rdata["mes"],{icon:5})}})},button_del_downing:function(button){var loadT=layer.msg("正在删除任务...",{icon:16,time:0,shade:[0.3,"#000"]});var gid=button.getAttribute("gid");var post="gid="+gid;request_plugin("idown","download_del_doing_alone",post,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("删除任务成功...",{icon:1});idown.get_down_active()}else{layer.close(loadT);layer.msg("删除任务失败..."+rdata["mes"],{icon:5})}})},button_del_over:function(button,file){var loadT=layer.msg("正在启动任务...",{icon:16,time:0,shade:[0.3,"#000"]});var gid=button.getAttribute("gid");var action;if(file==0){action="deldown"}else{action="delfile"}var post={gid:gid,delaction:action};request_plugin("idown","download_del_over_alone",post,function(rdata){if(rdata["server_result"]=="success"){layer.close(loadT);layer.msg("删除任务成功...",{icon:1});idown.get_down_stop()}else{layer.close(loadT);layer.msg("删除任务失败..."+rdata["mes"],{icon:5})}})},};function request_plugin(plugin_name,function_name,args,callback,isfile,timeout){if(!timeout){timeout=3600}if(!isfile){$.ajax({type:"POST",url:"/plugin?action=a&s="+function_name+"&name="+plugin_name,data:args,timeout:timeout,success:function(rdata){if(!callback){layer.msg(rdata.msg,{icon:rdata.status?1:2});return}return callback(rdata)},error:function(ex){if(!callback){layer.msg("请求过程发现错误!",{icon:2});return}return callback(ex)}})}else{$.ajax({type:"POST",url:"/plugin?action=a&s="+function_name+"&name="+plugin_name,data:args,timeout:timeout,cache:false,processData:false,contentType:false,success:function(rdata){if(!callback){layer.msg(rdata.msg,{icon:rdata.status?1:2});return}return callback(rdata)},error:function(ex){if(!callback){layer.msg("请求过程发现错误!",{icon:2});
return}return callback(ex)}})}}function count_array(o){var t=typeof o;if(t=="string"){return o.length}else{if(t=="object"){var n=0;for(var i in o){n++}return n}}return false}function getsize(size,num){if(size<=1048576){size=(size/1024).toFixed(num)+"KB"}else{if(size>=1048576&&size<1073741824){size=(size/1048576).toFixed(num)+"MB"}else{if(size>=1073741824){size=(size/1073741824).toFixed(num)+"GB"}}}return size}idown.get_down_index();setInterval("idown.get_down_index()",2000);setInterval("idown.get_down_active()",2000);setInterval("idown.get_down_stop()",2000);